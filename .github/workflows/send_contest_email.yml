name: Send Contest Email

on:
  schedule:
    - cron: '0 8 * * *' # 每天 08:00 UTC 运行，可在仓库设置中调整
  workflow_dispatch: {}

jobs:
  send_email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Prepare config
        run: |
          # 使用仓库 secret 创建 config.json
          mkdir -p mailer
          cat > mailer/config.json <<'JSON'
          {
            "smtp": {
              "host": "${{ secrets.SMTP_HOST }}",
              "port": ${{ secrets.SMTP_PORT }},
              "username": "${{ secrets.SMTP_USERNAME }}",
              "password": "${{ secrets.SMTP_PASSWORD }}",
              "from": "${{ secrets.SMTP_FROM }}"
            },
            "to": [${{ secrets.TO_ADDRESSES }}],
            "subject": "比赛提醒 - ${{ github.run_date }}"
          }
          JSON

      - name: Run mailer
        env:
          PYTHONUNBUFFERED: 1
        run: |
          python -c "import mailer.send_contest_email as m; m.main()"
